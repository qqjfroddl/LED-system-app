<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#6366f1">
    <link rel="icon" type="image/svg+xml" href="timer-icon.svg">
    <title>Î∂ÑÏ∂ú ÌÉÄÏù¥Î®∏</title>
    <style>
        :root {
            --bg-gradient: radial-gradient(circle at top, #dfe8ff 0%, #f7f0ff 45%, #fefefe 90%);
            --card-bg: rgba(255, 255, 255, 0.85);
            --accent: #7c3aed;
            --accent-2: #0ea5e9;
            --text-dark: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: clamp(24px, 5vw, 48px) clamp(12px, 4vw, 32px);
            color: var(--text-dark);
        }
        .timer-card {
            width: min(520px, 96vw);
            background: var(--card-bg);
            border-radius: 32px;
            padding: clamp(28px, 5vw, 40px);
            box-shadow: 0 40px 100px rgba(79, 70, 229, 0.18), inset 0 0 0 1px rgba(255, 255, 255, 0.4);
            text-align: center;
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.45);
        }
        @media (max-width: 520px) {
            .timer-card {
                width: min(420px, 92vw);
            }
        }
        @media (max-width: 420px) {
            .timer-card {
                width: min(320px, 88vw);
            }
            .preset-row {
                gap: 6px;
            }
            .chip {
                padding: 7px 10px;
                font-size: 0.85rem;
            }
            .time-display {
                font-size: clamp(2.7rem, 12vw, 3.6rem);
                letter-spacing: 1px;
            }
            .display-panel {
                padding: 24px 14px;
            }
            .settings-card {
                padding: 16px;
            }
        }
        .badge {
            display: inline-flex;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(14, 165, 233, 0.12);
            color: var(--accent-2);
            font-size: 0.85rem;
            letter-spacing: 1px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        h1 {
            margin: 4px 0 0;
            font-size: clamp(1.7rem, 3.2vw, 2.3rem);
            color: var(--text-dark);
        }
        .subtitle {
            margin: 8px 0 32px;
            color: var(--text-muted);
            font-size: 1rem;
        }
        .display-panel {
            margin-bottom: 24px;
            border-radius: 28px;
            padding: 36px 24px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #22d3ee);
            color: #fff;
            box-shadow: inset 0 -12px 30px rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        .display-panel::after {
            content: '';
            position: absolute;
            inset: 10px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            pointer-events: none;
        }
        .time-display {
            font-size: clamp(3.4rem, 9vw, 4.4rem);
            font-weight: 700;
            letter-spacing: 4px;
            margin: 0;
        }
        .status-label {
            margin: 12px 0 0;
            opacity: 0.9;
            font-size: 1.05rem;
        }
        .preset-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 12px;
        }
        .chip {
            border: none;
            border-radius: 12px;
            padding: 10px 16px;
            background: #f4f7ff;
            color: #1e1b4b;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .chip.active {
            background: rgba(59, 130, 246, 0.12);
            color: #fff;
            color: #1d4ed8;
            border-color: rgba(37,99,235,0.4);
            box-shadow: 0 10px 25px rgba(37,99,235,0.25);
        }
        .custom-box {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .custom-box.show { display: flex; }
        input {
            border: 1px solid #c7d2fe;
            border-radius: 12px;
            padding: 10px;
            width: 120px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.8);
        }
        .custom-box .apply {
            background: #22c55e;
            color: #fff;
        }
        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 18px 0 8px;
        }
        button {
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        button:active { transform: scale(0.98); }
        .primary {
            flex: 1;
            padding: 14px;
            border-radius: 16px;
            border: none;
            background: #10b981;
            color: white;
            box-shadow: 0 12px 24px rgba(16,185,129,0.35);
        }
        .secondary {
            flex: 1;
            padding: 14px;
            border-radius: 16px;
            border: none;
            background: #dbeafe;
            color: #1e3a8a;
        }
        .ghost {
            width: 100%;
            padding: 10px;
            border-radius: 16px;
            border: 1px dashed #cbd5f5;
            background: transparent;
            color: #64748b;
            margin-bottom: 10px;
        }
        .info-card {
            margin-top: 20px;
            padding: 18px 20px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(59,130,246,0.15));
            color: #064e3b;
            border: 1px solid rgba(16, 185, 129, 0.25);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        .info-card strong {
            font-size: 1.8rem;
            color: #0f172a;
        }
        .info-minute-row {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .settings-card {
            margin-top: 16px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            padding: 18px 20px;
            background: rgba(248, 250, 252, 0.8);
            text-align: left;
            box-shadow: inset 0 1px 15px rgba(226, 232, 240, 0.6);
        }
        .settings-card h2 {
            margin: 0 0 18px;
            font-size: 1.05rem;
            color: var(--text-dark);
            letter-spacing: 0.5px;
        }
        .setting-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }
        .setting-field {
            flex: 1;
            min-width: 160px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .setting-label {
            font-size: 0.9rem;
            color: #475569;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        input[type="range"] {
            flex: 1;
            appearance: none;
            -webkit-appearance: none;
            height: 10px;
            border-radius: 999px;
            background: #e2e8f0;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0d9488;
            box-shadow: 0 2px 6px rgba(13, 148, 136, 0.4);
            cursor: pointer;
            border: 2px solid #f0fdf4;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0d9488;
            box-shadow: 0 2px 6px rgba(13, 148, 136, 0.4);
            border: 2px solid #f0fdf4;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-track {
            background: transparent;
        }
        .setting-field.select {
            max-width: 140px;
        }
        select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid #cbd5f5;
            font-size: 0.95rem;
        }
        audio { display: none; }
    </style>
</head>
<body>
    <div class="timer-card">
        <h1><span style="font-size:0.9em;vertical-align:middle;">‚è±Ô∏è</span> Î∂ÑÏ∂ú ÌÉÄÏù¥Î®∏</h1>
        <p class="subtitle">ÏßëÏ§ëÌï¥ÏÑú ÏùºÌïòÎäî ÏãúÍ∞ÑÏùÑ ÏÑ§Ï†ïÌïòÏÑ∏Ïöî</p>

        <div class="display-panel">
            <div class="time-display" id="time-display">00:00</div>
            <p class="status-label" id="status-text">ÏãúÍ∞Ñ ÏÑ§Ï†ï ÌïÑÏöî</p>
        </div>

        <div class="preset-row">
            <button class="chip" data-min="5">5Î∂Ñ</button>
            <button class="chip" data-min="10">10Î∂Ñ</button>
            <button class="chip" data-min="15">15Î∂Ñ</button>
            <button class="chip" data-min="20">20Î∂Ñ</button>
            <button class="chip" id="toggle-custom">ÏãúÍ∞ÑÏÑ§Ï†ï</button>
        </div>

        <div class="custom-box" id="custom-box">
            <input type="number" id="custom-min" placeholder="Ïòà: 25" min="1" max="180">
            <button class="chip apply" id="apply-custom">Ï†ÅÏö©</button>
        </div>

        <div class="controls">
            <button class="secondary" id="pause-btn" disabled>ÏùºÏãúÏ†ïÏßÄ</button>
        </div>
        <button class="ghost" id="reset-btn" disabled>‚ü≥ Î¶¨ÏÖã</button>

        <div class="info-card">
            <span>Ïò§Îäò ÏßëÏ§ëÌïú ÏãúÍ∞Ñ</span>
            <div class="info-minute-row">
                <strong id="focused-minutes">0</strong>
                <span>Î∂Ñ</span>
            </div>
        </div>

        <div class="settings-card">
            <h2>ÏïåÎûå ÏÑ§Ï†ï</h2>
            <div class="setting-row">
                <div class="setting-field">
                    <div class="setting-label">ÏïåÎûå ÏÜåÎ¶¨ ÌÅ¨Í∏∞</div>
                    <div class="slider-row">
                        <input type="range" id="alarm-volume" min="0" max="100" value="50">
                        <div id="volume-display" style="font-size:0.95rem;color:#0d9488;width:48px;text-align:right;">50%</div>
                    </div>
                </div>
                <div class="setting-field select">
                    <div class="setting-label">ÏïåÎûå Í∏∏Ïù¥</div>
                    <select id="alarm-length">
                        <option value="3">3Ï¥à</option>
                        <option value="5" selected>5Ï¥à</option>
                        <option value="10">10Ï¥à</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                <div class="setting-label" style="margin-bottom: 8px;">ÏãúÏä§ÌÖú ÏïåÎ¶º</div>
                <div id="notification-status" style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">
                    ÌôïÏù∏ Ï§ë...
                </div>
                <button id="request-notification-btn" class="chip" style="background: #3b82f6; color: white; border: none; width: 100%; display: none;">
                    ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠
                </button>
            </div>
        </div>
    </div>

    <audio id="alarm-audio"></audio>

    <script>
        const FALLBACK_ALARM_SRC = 'data:audio/wav;base64,UklGRtQXAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YYQXAAAAdP9VgAQAqwgA6WcAIVUDTDYEPqsUcf3YAjX8wm2M6X1RZTKZoytDXuRqUS549fwLPar1EvBR/I12fMhZpNVGQljwnrvVAjPFVq7nDosQcUKFFs1jRNwE4YcuxSpQw3MWTZ2q9NWlQFXjZ3UR2SFvgtCsOxEylwAxyJbu2yeC3N4jYzT6ANPa+D4PPMGLQ9dmdHQAAA==';

        const timeDisplay = document.getElementById('time-display');
        const focusedEl = document.getElementById('focused-minutes');
        const statusText = document.getElementById('status-text');
        const alarmAudio = document.getElementById('alarm-audio');
        const volumeSlider = document.getElementById('alarm-volume');
        const volumeDisplay = document.getElementById('volume-display');
        const lengthSelect = document.getElementById('alarm-length');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const chips = document.querySelectorAll('.chip[data-min]');
        const toggleCustomBtn = document.getElementById('toggle-custom');
        const customBox = document.getElementById('custom-box');

        let totalSeconds = 0;
        let remainingSeconds = 0;
        let timerWorker = null;
        let targetTimestamp = null;
        let isRunning = false;
        
        // ÎÇ†ÏßúÎ≥ÑÎ°ú ÏßëÏ§ë ÏãúÍ∞Ñ Ï†ÄÏû•
        const getTodayKey = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const date = String(today.getDate()).padStart(2, '0');
            return `standaloneFocusedMinutes_${year}-${month}-${date}`;
        };
        
        let accumulatedMinutes = Number(localStorage.getItem(getTodayKey()) || 0);
        focusedEl.textContent = accumulatedMinutes;

        const updateDisplay = () => {
            const min = String(Math.floor(remainingSeconds / 60)).padStart(2, '0');
            const sec = String(remainingSeconds % 60).padStart(2, '0');
            timeDisplay.textContent = `${min}:${sec}`;
        };

        const setStatus = (state) => {
            if (state === 'running') {
                statusText.textContent = 'ÏßëÏ§ë Ï§ë';
            } else if (state === 'paused') {
                statusText.textContent = 'ÏùºÏãúÏ†ïÏßÄÎê®';
            } else if (remainingSeconds === 0) {
                statusText.textContent = 'ÏãúÍ∞Ñ ÏÑ§Ï†ï ÌïÑÏöî';
            } else {
                statusText.textContent = 'Ï§ÄÎπÑ ÏôÑÎ£å';
            }
        };

        const initTimerWorker = () => {
            if (timerWorker) return;
            const workerCode = `
                let target = null;
                let interval = 250;
                let timerId = null;
                const clearTimer = () => {
                    if (timerId) {
                        clearInterval(timerId);
                        timerId = null;
                    }
                };
                const tick = () => {
                    if (!target) return;
                    const remaining = Math.max(0, target - Date.now());
                    postMessage({ type: 'tick', remaining });
                    if (remaining <= 0) {
                        clearTimer();
                        postMessage({ type: 'complete' });
                    }
                };
                self.onmessage = (event) => {
                    const { type, payload } = event.data || {};
                    if (type === 'start') {
                        target = Date.now() + (payload?.remainingMs || 0);
                        interval = payload?.interval || 250;
                        clearTimer();
                        timerId = setInterval(tick, interval);
                        tick();
                    } else if (type === 'pause') {
                        const remaining = target ? Math.max(0, target - Date.now()) : 0;
                        clearTimer();
                        target = null;
                        postMessage({ type: 'paused', remaining });
                    } else if (type === 'stop') {
                        clearTimer();
                        target = null;
                        postMessage({ type: 'stopped' });
                    }
                };
            `;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            timerWorker = new Worker(URL.createObjectURL(blob));
            timerWorker.onmessage = (event) => {
                const { type, remaining } = event.data || {};
                if (type === 'tick') {
                    const nextRemaining = Math.ceil((remaining || 0) / 1000);
                    if (nextRemaining !== remainingSeconds) {
                        remainingSeconds = nextRemaining;
                        updateDisplay();
                    }
                } else if (type === 'complete') {
                    completeTimer();
                } else if (type === 'paused') {
                    remainingSeconds = Math.ceil((remaining || 0) / 1000);
                    updateDisplay();
                } else if (type === 'stopped') {
                    // no-op
                }
            };
        };

        const startTimer = () => {
            if (remainingSeconds <= 0) {
                alert('Î®ºÏ†Ä ÏãúÍ∞ÑÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            if (isRunning) return;
            isRunning = true;
            setStatus('running');
            pauseBtn.disabled = false;
            resetBtn.disabled = false;
            initTimerWorker();
            const remainingMs = remainingSeconds * 1000;
            targetTimestamp = Date.now() + remainingMs;
            timerWorker.postMessage({ type: 'start', payload: { remainingMs, interval: 250 } });
        };

        const pauseTimer = () => {
            if (!isRunning) return;
            isRunning = false;
            setStatus('paused');
            pauseBtn.disabled = true;
            if (timerWorker) {
                timerWorker.postMessage({ type: 'pause' });
            }
            targetTimestamp = null;
        };

        const resetTimer = () => {
            isRunning = false;
            if (timerWorker) {
                timerWorker.postMessage({ type: 'stop' });
            }
            remainingSeconds = totalSeconds;
            updateDisplay();
            setStatus('ready');
            pauseBtn.disabled = true;
            resetBtn.disabled = true;
            targetTimestamp = null;
        };

        const playAlarm = () => {
            const duration = Number(lengthSelect.value);
            const volume = Number(volumeSlider.value) / 100;
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (AudioCtx) {
                try {
                    const ctx = new AudioCtx();
                    const repeatChime = (offset) => {
                        const start = ctx.currentTime + offset;
                        const chord = [523.25, 659.25, 783.99];
                        chord.forEach((freq, idx) => {
                            const osc = ctx.createOscillator();
                            osc.type = 'sine';
                            osc.frequency.value = freq;
                            const gain = ctx.createGain();
                            const fade = 0.9;
                            const peak = volume * (idx === 0 ? 0.6 : 0.4);
                            gain.gain.setValueAtTime(0, start);
                            gain.gain.linearRampToValueAtTime(peak, start + 0.05);
                            gain.gain.exponentialRampToValueAtTime(0.001, start + fade);
                            const detuneOsc = ctx.createOscillator();
                            detuneOsc.type = 'sine';
                            detuneOsc.frequency.value = freq * 2;
                            const detuneGain = ctx.createGain();
                            detuneGain.gain.value = peak * 0.2;
                            detuneOsc.connect(detuneGain);
                            detuneGain.connect(gain);
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            osc.start(start);
                            osc.stop(start + fade);
                            detuneOsc.start(start);
                            detuneOsc.stop(start + fade);
                        });
                    };
                    for (let i = 0; i < duration; i++) {
                        repeatChime(i);
                    }
                    return;
                } catch (error) {
                    console.warn('Web Audio ÏïåÎûå Ïû¨ÏÉù Ïã§Ìå®:', error);
                }
            }
            if (alarmAudio.getAttribute('src') !== FALLBACK_ALARM_SRC) {
                alarmAudio.setAttribute('src', FALLBACK_ALARM_SRC);
            }
            alarmAudio.volume = volume;
            let count = 0;
            const playOnce = () => {
                alarmAudio.currentTime = 0;
                alarmAudio.play().catch(() => {});
                count++;
                if (count < duration) {
                    setTimeout(playOnce, 1000);
                }
            };
            playOnce();
        };

        const completeTimer = () => {
            isRunning = false;
            if (timerWorker) {
                timerWorker.postMessage({ type: 'stop' });
            }
            setStatus('ready');
            pauseBtn.disabled = true;
            resetBtn.disabled = true;
            remainingSeconds = 0;
            targetTimestamp = null;
            updateDisplay();

            const minutes = Math.max(1, Math.round(totalSeconds / 60));
            accumulatedMinutes += minutes;
            focusedEl.textContent = accumulatedMinutes;
            localStorage.setItem(getTodayKey(), accumulatedMinutes);

            playAlarm();
            
            // ÌéòÏù¥ÏßÄ ÌÉÄÏù¥ÌãÄ Î≥ÄÍ≤ΩÏúºÎ°ú Î∏åÎùºÏö∞Ï†Ä ÌÉ≠ÏóêÏÑúÎèÑ ÏïåÎ¶º ÌëúÏãú
            const originalTitle = document.title;
            document.title = 'üîî ÏûëÏóÖ ÏôÑÎ£å! - Î∂ÑÏ∂ú ÌÉÄÏù¥Î®∏';
            
            // 5Ï¥à ÌõÑ ÏõêÎûò ÌÉÄÏù¥ÌãÄÎ°ú Î≥µÏõê
            setTimeout(() => {
                document.title = originalTitle;
            }, 5000);
            
            // Windows ÏãúÏä§ÌÖú Ìä∏Î†àÏù¥ ÏïåÎ¶º Î≥¥ÎÇ¥Í∏∞ Ìï®Ïàò
            const sendNotification = async () => {
                console.log('üîî ÏïåÎ¶º Ï†ÑÏÜ° ÏãúÏûë...');
                console.log('ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Í∞ÄÏãúÏÑ±:', document.visibilityState);
                console.log('Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ìè¨Í∑∏ÎùºÏö¥Îìú:', !document.hidden);
                
                if (!('Notification' in window)) {
                    console.warn('‚ùå Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                    return;
                }

                // ÏïåÎ¶º Í∂åÌïú ÌôïÏù∏ Î∞è ÏöîÏ≤≠
                let permission = Notification.permission;
                console.log('ÌòÑÏû¨ ÏïåÎ¶º Í∂åÌïú:', permission);
                
                if (permission === 'default') {
                    try {
                        permission = await Notification.requestPermission();
                        console.log('ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ Í≤∞Í≥º:', permission);
                    } catch (error) {
                        console.error('‚ùå ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ Ïã§Ìå®:', error);
                        return;
                    }
                }

                if (permission !== 'granted') {
                    console.warn('‚ùå ÏïåÎ¶º Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏïåÎ¶ºÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
                    alert('ÏïåÎ¶º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏïåÎ¶ºÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                const notificationBody = `ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!\nÏßëÏ§ëÌïú ÏãúÍ∞Ñ: ${minutes}Î∂Ñ\nÏò§Îäò ÎàÑÏ†Å: ${accumulatedMinutes}Î∂Ñ`;
                const notificationTitle = 'üîî Î∂ÑÏ∂ú ÌÉÄÏù¥Î®∏ ÏôÑÎ£å!';
                
                // Î∏åÎùºÏö∞Ï†ÄÎ•º Ïû†Ïãú Î∞±Í∑∏ÎùºÏö¥ÎìúÎ°ú Î≥¥ÎÇ¥ÏÑú Windows ÏïåÎ¶ºÏù¥ ÌôïÏã§Ìûà ÌëúÏãúÎêòÎèÑÎ°ù
                // (Ïù¥Í±¥ ÏûëÎèôÌïòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏßÄÎßå ÏãúÎèÑÌï¥Î¥Ñ)
                const wasVisible = !document.hidden;

                // Ï§ëÏöî: Windows ÏïåÎ¶º ÏÑºÌÑ∞Ïóê ÌëúÏãúÎêòÎ†§Î©¥ Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Î∞±Í∑∏ÎùºÏö¥ÎìúÏóê ÏûàÏñ¥Ïïº Ìï©ÎãàÎã§
                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïàÎÇ¥ Î©îÏãúÏßÄ ÌëúÏãú
                if (!document.hidden) {
                    console.log('‚ö†Ô∏è Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ìè¨Í∑∏ÎùºÏö¥ÎìúÏóê ÏûàÏäµÎãàÎã§. Windows ÏïåÎ¶º ÏÑºÌÑ∞Ïóê ÌëúÏãúÎêòÎ†§Î©¥ Î∏åÎùºÏö∞Ï†ÄÎ•º ÏµúÏÜåÌôîÌïòÍ±∞ÎÇò Îã§Î•∏ Ï∞ΩÏùÑ ÌôúÏÑ±ÌôîÌï¥Ï£ºÏÑ∏Ïöî.');
                }
                
                // 1ÏàúÏúÑ: Service WorkerÎ•º ÌÜµÌïú ÏïåÎ¶º (ÏãúÏä§ÌÖú Ìä∏Î†àÏù¥Ïóê ÌëúÏãúÎê®)
                if ('serviceWorker' in navigator) {
                    try {
                        console.log('Service WorkerÎ•º ÌÜµÌïú ÏïåÎ¶º ÏãúÎèÑ...');
                        const registration = await navigator.serviceWorker.ready;
                        console.log('Service Worker Ï§ÄÎπÑ ÏôÑÎ£å:', registration);
                        console.log('Service Worker ÌôúÏÑ± ÏÉÅÌÉú:', registration.active ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±');
                        
                        // Service WorkerÎ•º ÌÜµÌï¥ ÏïåÎ¶º Ï†ÑÏÜ° (Windows ÏïåÎ¶º ÏÑºÌÑ∞Ïóê ÌëúÏãú)
                        // Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ìè¨Í∑∏ÎùºÏö¥ÎìúÏóê ÏûàÏñ¥ÎèÑ Windows ÏïåÎ¶º ÏÑºÌÑ∞Ïóê ÌëúÏãúÎêòÎèÑÎ°ù ÏÑ§Ï†ï
                        const notificationOptions = {
                            body: notificationBody,
                            icon: 'timer-icon.svg',
                            badge: 'timer-icon.svg',
                            tag: `timer-complete-${Date.now()}`,
                            requireInteraction: true, // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë Îã´ÏùÑ ÎïåÍπåÏßÄ Ïú†ÏßÄ
                            silent: false,
                            vibrate: [200, 100, 200, 100, 200],
                            timestamp: Date.now(),
                            renotify: true, // Í∞ôÏùÄ ÌÉúÍ∑∏Ïùò ÏïåÎ¶ºÎèÑ Îã§Ïãú ÌëúÏãú
                            data: {
                                url: window.location.href,
                                minutes: minutes,
                                accumulated: accumulatedMinutes
                            }
                        };
                        
                        await registration.showNotification(notificationTitle, notificationOptions);
                        console.log('‚úÖ Service Worker ÏïåÎ¶º Ï†ÑÏÜ° ÏÑ±Í≥µ');
                        
                        // Windows ÏïåÎ¶º ÏÑºÌÑ∞Ïóê ÌôïÏã§Ìûà ÌëúÏãúÎêòÎèÑÎ°ù ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Îã§Ïãú Ìïú Î≤à Ï†ÑÏÜ°
                        setTimeout(async () => {
                            try {
                                await registration.showNotification(notificationTitle + ' (ÏôÑÎ£å)', {
                                    body: notificationBody,
                                    icon: 'timer-icon.svg',
                                    tag: `timer-complete-reminder-${Date.now()}`,
                                    requireInteraction: false,
                                    silent: false
                                });
                                console.log('‚úÖ ÏïåÎ¶º Î¶¨ÎßàÏù∏Îçî Ï†ÑÏÜ° ÏÑ±Í≥µ');
                            } catch (e) {
                                console.warn('Î¶¨ÎßàÏù∏Îçî ÏïåÎ¶º Ïã§Ìå®:', e);
                            }
                        }, 500);
                        
                        // Ï∂îÍ∞ÄÎ°ú ÏùºÎ∞ò ÏïåÎ¶ºÎèÑ Î≥¥ÎÇ¥ÏÑú ÌôïÏã§ÌïòÍ≤å (Î∏åÎùºÏö∞Ï†Ä ÎÇ¥Î∂Ä ÏïåÎ¶º)
                        try {
                            const fallbackNotification = new Notification(notificationTitle, {
                                body: notificationBody,
                                icon: 'timer-icon.svg',
                                requireInteraction: true,
                                tag: `timer-complete-fallback-${Date.now()}`
                            });
                            fallbackNotification.onclick = () => {
                                window.focus();
                                fallbackNotification.close();
                            };
                            console.log('‚úÖ ÏùºÎ∞ò ÏïåÎ¶ºÎèÑ Ï†ÑÏÜ° ÏÑ±Í≥µ (Î∏åÎùºÏö∞Ï†Ä ÎÇ¥Î∂Ä)');
                        } catch (fallbackError) {
                            console.warn('ÏùºÎ∞ò ÏïåÎ¶º Ï†ÑÏÜ° Ïã§Ìå® (Î¨¥Ïãú Í∞ÄÎä•):', fallbackError);
                        }
                        
                        return;
                    } catch (error) {
                        console.error('‚ùå Service Worker ÏïåÎ¶º Ïã§Ìå®:', error);
                        // Service Worker Ïã§Ìå® Ïãú ÏùºÎ∞ò ÏïåÎ¶ºÏúºÎ°ú ÎåÄÏ≤¥
                    }
                }

                // 2ÏàúÏúÑ: ÏùºÎ∞ò Î∏åÎùºÏö∞Ï†Ä ÏïåÎ¶º (Service WorkerÍ∞Ä ÏóÜÏùÑ Îïå)
                try {
                    console.log('ÏùºÎ∞ò ÏïåÎ¶º ÏãúÎèÑ...');
                    const notification = new Notification(notificationTitle, {
                        body: notificationBody,
                        icon: 'timer-icon.svg',
                        requireInteraction: true,
                        tag: `timer-complete-${Date.now()}`
                    });
                    
                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                    
                    console.log('‚úÖ ÏùºÎ∞ò ÏïåÎ¶º Ï†ÑÏÜ° ÏÑ±Í≥µ');
                } catch (error) {
                    console.error('‚ùå ÏùºÎ∞ò ÏïåÎ¶ºÎèÑ Ïã§Ìå®:', error);
                    alert('ÏïåÎ¶º Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏΩòÏÜîÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
            };

            // ÏïåÎ¶º Ï†ÑÏÜ°
            sendNotification().catch(error => {
                console.error('ÏïåÎ¶º Ï†ÑÏÜ° Ï§ë ÏòàÏô∏ Î∞úÏÉù:', error);
            });
            
            alert(`ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!\n\nÏßëÏ§ëÌïú ÏãúÍ∞Ñ: ${minutes}Î∂Ñ\nÏò§Îäò ÎàÑÏ†Å: ${accumulatedMinutes}Î∂Ñ`);
        };

        const setMinutes = (min, autoStart = false) => {
            totalSeconds = min * 60;
            remainingSeconds = totalSeconds;
            updateDisplay();
            setStatus('ready');
            chips.forEach(btn => btn.classList.remove('active'));
            pauseBtn.disabled = true;
            resetBtn.disabled = true;
            if (autoStart) {
                startTimer();
            }
        };

        const updateVolumeVisual = () => {
            const percent = Number(volumeSlider.value);
            volumeDisplay.textContent = `${percent}%`;
            volumeSlider.style.background = `linear-gradient(90deg, #0d9488 ${percent}%, #e2e8f0 ${percent}%)`;
        };

        volumeSlider.addEventListener('input', updateVolumeVisual);

        chips.forEach(btn => {
            btn.addEventListener('click', () => {
                chips.forEach(item => item.classList.remove('active'));
                btn.classList.add('active');
                setMinutes(Number(btn.dataset.min), true);
            });
        });

        toggleCustomBtn.addEventListener('click', () => {
            customBox.classList.toggle('show');
        });

        document.getElementById('apply-custom').addEventListener('click', () => {
            const value = Number(document.getElementById('custom-min').value);
            if (!value || value < 1 || value > 180) {
                alert('1~180Î∂Ñ ÏÇ¨Ïù¥Ïùò Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            setMinutes(value, true);
        });

        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);

        updateVolumeVisual();
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && targetTimestamp) {
                const remainingMs = Math.max(0, targetTimestamp - Date.now());
                const nextRemaining = Math.ceil(remainingMs / 1000);
                if (nextRemaining !== remainingSeconds) {
                    remainingSeconds = nextRemaining;
                    updateDisplay();
                }
                if (remainingMs <= 0 && isRunning) {
                    completeTimer();
                }
            }
        });

        let serviceWorkerRegistration = null;

        const registerServiceWorker = async () => {
            if ('serviceWorker' in navigator) {
                try {
                    console.log('Service Worker Îì±Î°ù ÏãúÎèÑ...');
                    const registration = await navigator.serviceWorker.register('timer-service-worker.js', {
                        scope: './'
                    });
                    serviceWorkerRegistration = registration;
                    console.log('‚úÖ Service Worker Îì±Î°ù ÏôÑÎ£å:', registration.scope);
                    console.log('Service Worker ÏÉÅÌÉú:', registration.active ? 'active' : 'installing');
                    
                    // Service WorkerÍ∞Ä ÌôúÏÑ±ÌôîÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
                    if (registration.installing) {
                        console.log('Service Worker ÏÑ§Ïπò Ï§ë...');
                        registration.installing.addEventListener('statechange', () => {
                            console.log('Service Worker ÏÉÅÌÉú Î≥ÄÍ≤Ω:', registration.installing.state);
                        });
                    }
                    
                    if (registration.waiting) {
                        console.log('Service Worker ÎåÄÍ∏∞ Ï§ë...');
                    }
                    
                    if (registration.active) {
                        console.log('Service Worker ÌôúÏÑ±ÌôîÎê®');
                    }
                    
                    // Service Worker ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏
                    registration.addEventListener('updatefound', () => {
                        console.log('ÏÉàÎ°úÏö¥ Service Worker Î∞úÍ≤¨');
                    });
                    
                    // Service Worker Ïª®Ìä∏Î°§Îü¨ Î≥ÄÍ≤Ω Í∞êÏßÄ
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        console.log('Service Worker Ïª®Ìä∏Î°§Îü¨ Î≥ÄÍ≤ΩÎê®');
                    });
                    
                } catch (error) {
                    console.error('‚ùå Service Worker Îì±Î°ù Ïã§Ìå®:', error);
                    console.error('ÏÉÅÏÑ∏ Ïò§Î•ò:', error.message, error.stack);
                }
            } else {
                console.warn('‚ö†Ô∏è Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî Service WorkerÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
            }
        };

        // ÏïåÎ¶º Í∂åÌïú ÏÉÅÌÉú UI ÏóÖÎç∞Ïù¥Ìä∏
        const updateNotificationStatus = () => {
            const statusEl = document.getElementById('notification-status');
            const requestBtn = document.getElementById('request-notification-btn');
            
            if (!('Notification' in window)) {
                statusEl.textContent = '‚ùå Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.';
                statusEl.style.color = '#ef4444';
                requestBtn.style.display = 'none';
                return;
            }

            const permission = Notification.permission;
            
            if (permission === 'granted') {
                statusEl.textContent = '‚úÖ ÏïåÎ¶º Í∂åÌïúÏù¥ ÌóàÏö©ÎêòÏóàÏäµÎãàÎã§. ÏãúÏä§ÌÖú Ìä∏Î†àÏù¥Ïóê ÏïåÎ¶ºÏù¥ ÌëúÏãúÎê©ÎãàÎã§.';
                statusEl.style.color = '#10b981';
                requestBtn.style.display = 'none';
            } else if (permission === 'denied') {
                statusEl.textContent = '‚ùå ÏïåÎ¶º Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú Î≥ÄÍ≤ΩÌï¥Ï£ºÏÑ∏Ïöî.';
                statusEl.style.color = '#ef4444';
                requestBtn.style.display = 'none';
            } else {
                statusEl.textContent = '‚ö†Ô∏è ÏïåÎ¶º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. ÏãúÏä§ÌÖú Ìä∏Î†àÏù¥ ÏïåÎ¶ºÏùÑ Î∞õÏúºÎ†§Î©¥ Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.';
                statusEl.style.color = '#f59e0b';
                requestBtn.style.display = 'block';
            }
        };

        // ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ Ìï®Ïàò
        const requestNotificationPermission = async () => {
            if (!('Notification' in window)) {
                console.warn('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                updateNotificationStatus();
                return;
            }

            if (Notification.permission === 'default') {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        console.log('‚úÖ ÏïåÎ¶º Í∂åÌïúÏù¥ ÌóàÏö©ÎêòÏóàÏäµÎãàÎã§.');
                    } else {
                        console.warn('‚ö†Ô∏è ÏïåÎ¶º Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§.');
                    }
                    updateNotificationStatus();
                } catch (error) {
                    console.error('‚ùå ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ Ï§ë Ïò§Î•ò:', error);
                    updateNotificationStatus();
                }
            } else {
                updateNotificationStatus();
            }
        };

        // ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        document.getElementById('request-notification-btn').addEventListener('click', async () => {
            await requestNotificationPermission();
        });

        // Ï¥àÍ∏∞Ìôî
        registerServiceWorker().then(() => {
            updateNotificationStatus();
        });
        requestNotificationPermission();
        updateDisplay();
    </script>
</body>
</html>

