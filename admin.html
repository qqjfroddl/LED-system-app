<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì-LEDsystem</title>
    <link rel="icon" type="image/svg+xml" href="admin-favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>ê´€ë¦¬ì-LEDsystem</h1>
            <p class="subtitle">LEDsystem ì‚¬ìš©ì ìŠ¹ì¸ ê´€ë¦¬</p>
            <a href="index.html" class="back-link">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </header>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-container">
            <div class="stat-card pending">
                <div class="stat-icon">â³</div>
                <div class="stat-info">
                    <p class="stat-label">ëŒ€ê¸° ì¤‘</p>
                    <p class="stat-value" id="pending-count">0</p>
                </div>
            </div>
            <div class="stat-card approved">
                <div class="stat-icon">âœ…</div>
                <div class="stat-info">
                    <p class="stat-label">ìŠ¹ì¸ëœ ì‚¬ìš©ì</p>
                    <p class="stat-value" id="approved-count">0</p>
                </div>
            </div>
            <div class="stat-card total">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-info">
                    <p class="stat-label">ì „ì²´ ì‚¬ìš©ì</p>
                    <p class="stat-value" id="total-count">0</p>
                </div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="pending">
                â³ ìŠ¹ì¸ ëŒ€ê¸° (<span id="pending-tab-count">0</span>)
            </button>
            <button class="tab-btn" data-tab="approved">
                âœ… ìŠ¹ì¸ëœ ì‚¬ìš©ì (<span id="approved-tab-count">0</span>)
            </button>
        </div>

        <!-- ìŠ¹ì¸ ëŒ€ê¸° íƒ­ -->
        <div id="pending-tab" class="tab-content active">
            <div class="users-section">
                <h2>ğŸ”” ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ì</h2>
                <div class="refresh-info">
                    <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update">-</span></span>
                    <button class="refresh-btn" onclick="loadAllData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>í”„ë¡œí•„</th>
                                <th>ì´ë¦„</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ìš”ì²­ì¼ì‹œ</th>
                                <th>ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="pending-users-body">
                            <tr>
                                <td colspan="5" class="loading">ë¡œë”© ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ìŠ¹ì¸ëœ ì‚¬ìš©ì íƒ­ -->
        <div id="approved-tab" class="tab-content">
            <div class="users-section">
                <h2>âœ… ìŠ¹ì¸ëœ ì‚¬ìš©ì</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>í”„ë¡œí•„</th>
                                <th>ì´ë¦„</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ì—­í• </th>
                                <th>ê°€ì…ì¼</th>
                                <th>ìŠ¹ì¸ì¼</th>
                                <th>ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody id="approved-users-body">
                            <tr>
                                <td colspan="7" class="loading">ë¡œë”© ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
        <div id="toast" class="toast"></div>
    </div>

    <script>
        // Supabase ì´ˆê¸°í™”
        // TODO: script.jsì™€ ë™ì¼í•œ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”
        const SUPABASE_URL = 'https://faeoveodareburrulgqs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhZW92ZW9kYXJlYnVycnVsZ3FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyODU3NTUsImV4cCI6MjA3ODg2MTc1NX0.7fxmJQaJrpJqkBM5wtCqWi8D_wEDqgbxXzPpw6Y9DEM';

        let supabase = null;

        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('âœ… Supabase ì—°ê²°ë¨');
        } else {
            alert('âš ï¸ Supabase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\nsupabase-setup.md ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì—¬ ì„¤ì •í•˜ì„¸ìš”.');
        }

        // ì „ì—­ ë³€ìˆ˜
        let pendingUsers = [];
        let approvedUsers = [];

        // ëª¨ë“  ë°ì´í„° ë¡œë“œ
        async function loadAllData() {
            if (!supabase) {
                showToast('Supabaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                // ë¯¸ìŠ¹ì¸ ì‚¬ìš©ì (is_approvedê°€ falseì´ê±°ë‚˜ nullì¸ ê²½ìš°)
                const { data: pending, error: pendingError } = await supabase
                    .from('users')
                    .select('*')
                    .or('is_approved.is.null,is_approved.eq.false')
                    .order('requested_at', { ascending: false, nullsFirst: false });
                
                if (pendingError) throw pendingError;
                pendingUsers = pending || [];
                
                // ìŠ¹ì¸ëœ ì‚¬ìš©ì
                const { data: approved, error: approvedError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('is_approved', true)
                    .order('approved_at', { ascending: false });
                
                if (approvedError) throw approvedError;
                approvedUsers = approved || [];
                
                // ì „ì²´ ì‚¬ìš©ì ìˆ˜
                const totalCount = pendingUsers.length + approvedUsers.length;
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('pending-count').textContent = pendingUsers.length;
                document.getElementById('approved-count').textContent = approvedUsers.length;
                document.getElementById('total-count').textContent = totalCount;
                
                // íƒ­ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                document.getElementById('pending-tab-count').textContent = pendingUsers.length;
                document.getElementById('approved-tab-count').textContent = approvedUsers.length;
                
                // í…Œì´ë¸” ë Œë”ë§
                renderPendingUsers();
                renderApprovedUsers();
                
                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('ko-KR');
                
                console.log('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showToast('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¯¸ìŠ¹ì¸ ì‚¬ìš©ì í…Œì´ë¸” ë Œë”ë§
        function renderPendingUsers() {
            const tbody = document.getElementById('pending-users-body');
            
            if (pendingUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ‰</td></tr>';
            } else {
                tbody.innerHTML = pendingUsers.map(user => `
                    <tr>
                        <td>
                            <img src="${user.picture || 'https://via.placeholder.com/40'}" 
                                 alt="${user.name}" 
                                 class="user-avatar">
                        </td>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td>${formatDateTime(user.requested_at || user.created_at)}</td>
                        <td class="action-buttons">
                            <button class="btn btn-approve" onclick="approveUser('${user.id}', '${escapeHtml(user.email)}')">
                                âœ… ìŠ¹ì¸
                            </button>
                            <button class="btn btn-reject" onclick="rejectUser('${user.id}', '${escapeHtml(user.email)}')">
                                âŒ ê±°ì ˆ
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // ìŠ¹ì¸ëœ ì‚¬ìš©ì í…Œì´ë¸” ë Œë”ë§
        function renderApprovedUsers() {
            const tbody = document.getElementById('approved-users-body');
            
            if (approvedUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">ìŠ¹ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                tbody.innerHTML = approvedUsers.map(user => `
                    <tr>
                        <td>
                            <img src="${user.picture || 'https://via.placeholder.com/40'}" 
                                 alt="${user.name}" 
                                 class="user-avatar">
                        </td>
                        <td><strong>${user.name}</strong></td>
                        <td>${user.email}</td>
                        <td>
                            <span class="role-badge ${user.role || 'user'}">${getRoleName(user.role)}</span>
                        </td>
                        <td>${formatDateTime(user.requested_at)}</td>
                        <td>${formatDateTime(user.approved_at)}</td>
                        <td class="action-buttons">
                            <button class="btn btn-revoke" onclick="revokeApproval('${user.id}', '${escapeHtml(user.email)}')">
                                ğŸš« ìŠ¹ì¸ ì·¨ì†Œ
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // ì‚¬ìš©ì ìŠ¹ì¸
        async function approveUser(userId, email) {
            if (!confirm(`"${email}" ì‚¬ìš©ìë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .update({
                        is_approved: true,
                        approved_at: new Date().toISOString(),
                        approved_by: 'admin'
                    })
                    .eq('id', userId)
                    .select();
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    showToast('âœ… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    await loadAllData();
                } else {
                    throw new Error('ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ìŠ¹ì¸ ì‹¤íŒ¨:', error);
                showToast(`ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
            }
        }

        // ì‚¬ìš©ì ê±°ì ˆ (ì‚­ì œ)
        async function rejectUser(userId, email) {
            if (!confirm(`"${email}" ì‚¬ìš©ìë¥¼ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId)
                    .select();
                
                if (error) throw error;
                
                // ì‚­ì œ ì„±ê³µ í™•ì¸ (DELETEëŠ” ì‚­ì œëœ í–‰ì„ ë°˜í™˜)
                if (data && data.length > 0) {
                    showToast('âŒ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (awaitë¡œ ì™„ë£Œ ëŒ€ê¸°)
                    await loadAllData();
                } else {
                    // RLS ì •ì±… ë¬¸ì œì¼ ìˆ˜ ìˆìŒ
                    console.warn('ì‚­ì œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. RLS ì •ì±…ì„ í™•ì¸í•˜ì„¸ìš”.');
                    showToast('ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆì§€ë§Œ ëª©ë¡ ê°±ì‹ ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'info');
                    // ê·¸ë˜ë„ ëª©ë¡ì€ ìƒˆë¡œê³ ì¹¨ ì‹œë„
                    await loadAllData();
                }
                
            } catch (error) {
                console.error('ê±°ì ˆ ì‹¤íŒ¨:', error);
                showToast(`ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
            }
        }

        // ìŠ¹ì¸ ì·¨ì†Œ
        async function revokeApproval(userId, email) {
            if (!confirm(`"${email}" ì‚¬ìš©ìì˜ ìŠ¹ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .update({
                        is_approved: false,
                        approved_at: null,
                        approved_by: null
                    })
                    .eq('id', userId)
                    .select();
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    showToast('ğŸš« ìŠ¹ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    await loadAllData();
                } else {
                    throw new Error('ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ìŠ¹ì¸ ì·¨ì†Œ ì‹¤íŒ¨:', error);
                showToast(`ìŠ¹ì¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // íƒ­ ì½˜í…ì¸  í‘œì‹œ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ì—­í•  ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getRoleName(role) {
            const roleMap = {
                'admin': 'ê´€ë¦¬ì',
                'user': 'ì¼ë°˜ ì‚¬ìš©ì'
            };
            return roleMap[role] || 'ì¼ë°˜ ì‚¬ìš©ì';
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (Supabase Realtime)
        if (supabase) {
            supabase
                .channel('users')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'users' 
                }, (payload) => {
                    console.log('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:', payload);
                    loadAllData();
                })
                .subscribe();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', () => {
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadAllData();
            
            // íƒ­ ë²„íŠ¼ í´ë¦­
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                });
            });
            
            // 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
            setInterval(loadAllData, 30000);
        });
    </script>
</body>
</html>


